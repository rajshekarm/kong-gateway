name: Deploy Kong Gateway

on:
  # push:
  #   branches:
  #     - main
  workflow_dispatch:  # Allows manual trigger

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required to checkout code

jobs:
  deploy:
    name: Deploy to EC2 via SSM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::589335871756:role/GitHubActionsRole
          aws-region: us-east-1  # Change to your region
      
      - name: Get EC2 Instance ID
        id: get-instance
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=kong-gateway-ec2" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)
          
          if [ "$INSTANCE_ID" = "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "‚ùå No running EC2 instance found with tag Name=Kong-Gateway"
            exit 1
          fi
          
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Found instance: $INSTANCE_ID"
      
      - name: Deploy to EC2 via SSM
        id: deploy
        run: |
          echo "üöÄ Deploying to EC2 instance: ${{ steps.get-instance.outputs.instance_id }}"
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.get-instance.outputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Kong Gateway from GitHub Actions (Commit: ${{ github.sha }})" \
            --parameters 'commands=[
              "set -e",
              "echo \"üì• Pulling latest code from GitHub...\"",
              "cd /home/ubuntu/kong-gateway || exit 1",
              "sudo -u ubuntu git fetch origin",
              "sudo -u ubuntu git reset --hard origin/main",
              "echo \"üì¶ Installing Python dependencies...\"",
              "sudo -u ubuntu pip3 install -r requirements.txt --quiet",
              "echo \"üîÑ Restarting Kong Gateway...\"",
              "sudo -u ubuntu python3 deploy.py restart",
              "echo \"‚úÖ Deployment complete!\"",
              "echo \"üè• Running health check...\"",
              "sudo -u ubuntu python3 deploy.py status"
            ]' \
            --timeout-seconds 300 \
            --output text \
            --query 'Command.CommandId')
          
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "üìã SSM Command ID: $COMMAND_ID"
          
          # Wait for command to complete
          echo "‚è≥ Waiting for deployment to complete..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.get-instance.outputs.instance_id }}" \
            --timeout 600
      
      - name: Get Deployment Output
        if: always()
        run: |
          echo "üìã Deployment output:"
          echo "===================="
          aws ssm get-command-invocation \
            --command-id "${{ steps.deploy.outputs.command_id }}" \
            --instance-id "${{ steps.get-instance.outputs.instance_id }}" \
            --query 'StandardOutputContent' \
            --output text
          
          echo ""
          echo "üìã Error output (if any):"
          echo "===================="
          aws ssm get-command-invocation \
            --command-id "${{ steps.deploy.outputs.command_id }}" \
            --instance-id "${{ steps.get-instance.outputs.instance_id }}" \
            --query 'StandardErrorContent' \
            --output text
      
      - name: Check Deployment Status
        run: |
          STATUS=$(aws ssm get-command-invocation \
            --command-id "${{ steps.deploy.outputs.command_id }}" \
            --instance-id "${{ steps.get-instance.outputs.instance_id }}" \
            --query 'Status' \
            --output text)
          
          echo "Deployment status: $STATUS"
          
          if [ "$STATUS" = "Success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed with status: $STATUS"
            exit 1
          fi
